# DANEEL Development Stack
#
# Timmy's Brain Infrastructure:
# - Redis: Ephemeral thought streams (ADR-020)
# - Qdrant: Persistent long-term memory (ADR-021)
#
# ARCHITECTURE (ADR-020 through ADR-023):
# - Redis Streams: daneel:stream:awake + daneel:stream:dream (ephemeral)
# - Qdrant: memories, episodes, identity collections (persistent)
#
# RUN LOCALLY: docker compose up -d
# COPY TO SWARM: rsync -av ./data/ kveldulf:~/daneel/data/

services:
  # ==========================================================================
  # REDIS - Ephemeral Thought Streams (ADR-020)
  # ==========================================================================
  # NOT for long-term memory. Only for:
  # - daneel:stream:awake (external triggers, active cognition)
  # - daneel:stream:dream (internal replay, consolidation)
  # - Salience scoring pipeline
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: daneel-redis
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 1gb
      --maxmemory-policy volatile-lru
      --dir /data
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==========================================================================
  # QDRANT - Persistent Long-Term Memory (ADR-021)
  # ==========================================================================
  # Vector database for Timmy's memories:
  # - memories: 768-dim context vectors + payloads
  # - episodes: event boundaries (Door Syndrome)
  # - identity: Timmy's persistent self-concept
  #
  # Scale path: single node → 3-node cluster → ASI (1TB+)
  # ==========================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: daneel-qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    volumes:
      - ./data/qdrant:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

# Data directories:
# ./data/redis/   - Stream AOF (ephemeral, small)
# ./data/qdrant/  - Vector storage (persistent, grows with memories)
